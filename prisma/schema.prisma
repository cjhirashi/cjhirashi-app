generator client {
  provider        = "prisma-client-js"
  output          = "../lib/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto, uuid_ossp(map: "uuid-ossp", schema: "extensions")]
  schemas    = ["auth", "public"]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_log_entries {
  instance_id String?   @db.Uuid
  id          String    @id @db.Uuid
  payload     Json?     @db.Json
  created_at  DateTime? @db.Timestamptz(6)
  ip_address  String    @default("") @db.VarChar(64)

  @@index([instance_id], map: "audit_logs_instance_id_idx")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model flow_state {
  id                     String                @id @db.Uuid
  user_id                String?               @db.Uuid
  auth_code              String
  code_challenge_method  code_challenge_method
  code_challenge         String
  provider_type          String
  provider_access_token  String?
  provider_refresh_token String?
  created_at             DateTime?             @db.Timestamptz(6)
  updated_at             DateTime?             @db.Timestamptz(6)
  authentication_method  String
  auth_code_issued_at    DateTime?             @db.Timestamptz(6)
  saml_relay_states      saml_relay_states[]

  @@index([created_at(sort: Desc)])
  @@index([auth_code], map: "idx_auth_code")
  @@index([user_id, authentication_method], map: "idx_user_id_auth_method")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model identities {
  provider_id     String
  user_id         String    @db.Uuid
  identity_data   Json
  provider        String
  last_sign_in_at DateTime? @db.Timestamptz(6)
  created_at      DateTime? @db.Timestamptz(6)
  updated_at      DateTime? @db.Timestamptz(6)
  email           String?   @default(dbgenerated("lower((identity_data ->> 'email'::text))"))
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  users           users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider_id, provider], map: "identities_provider_id_provider_unique")
  @@index([email])
  @@index([user_id])
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model instances {
  id              String    @id @db.Uuid
  uuid            String?   @db.Uuid
  raw_base_config String?
  created_at      DateTime? @db.Timestamptz(6)
  updated_at      DateTime? @db.Timestamptz(6)

  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model mfa_amr_claims {
  session_id            String   @db.Uuid
  created_at            DateTime @db.Timestamptz(6)
  updated_at            DateTime @db.Timestamptz(6)
  authentication_method String
  id                    String   @id(map: "amr_id_pk") @db.Uuid
  sessions              sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([session_id, authentication_method], map: "mfa_amr_claims_session_id_authentication_method_pkey")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model mfa_challenges {
  id                     String      @id @db.Uuid
  factor_id              String      @db.Uuid
  created_at             DateTime    @db.Timestamptz(6)
  verified_at            DateTime?   @db.Timestamptz(6)
  ip_address             String      @db.Inet
  otp_code               String?
  web_authn_session_data Json?
  mfa_factors            mfa_factors @relation(fields: [factor_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "mfa_challenges_auth_factor_id_fkey")

  @@index([created_at(sort: Desc)], map: "mfa_challenge_created_at_idx")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model mfa_factors {
  id                           String           @id @db.Uuid
  user_id                      String           @db.Uuid
  friendly_name                String?
  factor_type                  factor_type
  status                       factor_status
  created_at                   DateTime         @db.Timestamptz(6)
  updated_at                   DateTime         @db.Timestamptz(6)
  secret                       String?
  phone                        String?
  last_challenged_at           DateTime?        @unique @db.Timestamptz(6)
  web_authn_credential         Json?
  web_authn_aaguid             String?          @db.Uuid
  last_webauthn_challenge_data Json?
  mfa_challenges               mfa_challenges[]
  users                        users            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, phone], map: "unique_phone_factor_per_user")
  @@index([user_id, created_at], map: "factor_id_created_at_idx")
  @@index([user_id])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model oauth_authorizations {
  id                    String                     @id @db.Uuid
  authorization_id      String                     @unique
  client_id             String                     @db.Uuid
  user_id               String?                    @db.Uuid
  redirect_uri          String
  scope                 String
  state                 String?
  resource              String?
  code_challenge        String?
  code_challenge_method code_challenge_method?
  response_type         oauth_response_type        @default(code)
  status                oauth_authorization_status @default(pending)
  authorization_code    String?                    @unique
  created_at            DateTime                   @default(now()) @db.Timestamptz(6)
  expires_at            DateTime                   @default(dbgenerated("(now() + '00:03:00'::interval)")) @db.Timestamptz(6)
  approved_at           DateTime?                  @db.Timestamptz(6)
  oauth_clients         oauth_clients              @relation(fields: [client_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                 users?                     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model oauth_clients {
  id                   String                  @id @db.Uuid
  client_secret_hash   String?
  registration_type    oauth_registration_type
  redirect_uris        String
  grant_types          String
  client_name          String?
  client_uri           String?
  logo_uri             String?
  created_at           DateTime                @default(now()) @db.Timestamptz(6)
  updated_at           DateTime                @default(now()) @db.Timestamptz(6)
  deleted_at           DateTime?               @db.Timestamptz(6)
  client_type          oauth_client_type       @default(confidential)
  oauth_authorizations oauth_authorizations[]
  oauth_consents       oauth_consents[]
  sessions             sessions[]

  @@index([deleted_at])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model oauth_consents {
  id            String        @id @db.Uuid
  user_id       String        @db.Uuid
  client_id     String        @db.Uuid
  scopes        String
  granted_at    DateTime      @default(now()) @db.Timestamptz(6)
  revoked_at    DateTime?     @db.Timestamptz(6)
  oauth_clients oauth_clients @relation(fields: [client_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         users         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, client_id], map: "oauth_consents_user_client_unique")
  @@index([user_id, granted_at(sort: Desc)], map: "oauth_consents_user_order_idx")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model one_time_tokens {
  id         String              @id @db.Uuid
  user_id    String              @db.Uuid
  token_type one_time_token_type
  token_hash String
  relates_to String
  created_at DateTime            @default(now()) @db.Timestamp(6)
  updated_at DateTime            @default(now()) @db.Timestamp(6)
  users      users               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, token_type])
  @@index([relates_to], map: "one_time_tokens_relates_to_hash_idx", type: Hash)
  @@index([token_hash], map: "one_time_tokens_token_hash_hash_idx", type: Hash)
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model refresh_tokens {
  instance_id String?   @db.Uuid
  id          BigInt    @id @default(autoincrement())
  token       String?   @unique(map: "refresh_tokens_token_unique") @db.VarChar(255)
  user_id     String?   @db.VarChar(255)
  revoked     Boolean?
  created_at  DateTime? @db.Timestamptz(6)
  updated_at  DateTime? @db.Timestamptz(6)
  parent      String?   @db.VarChar(255)
  session_id  String?   @db.Uuid
  sessions    sessions? @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([instance_id])
  @@index([instance_id, user_id])
  @@index([parent])
  @@index([session_id, revoked])
  @@index([updated_at(sort: Desc)])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model saml_providers {
  id                String        @id @db.Uuid
  sso_provider_id   String        @db.Uuid
  entity_id         String        @unique
  metadata_xml      String
  metadata_url      String?
  attribute_mapping Json?
  created_at        DateTime?     @db.Timestamptz(6)
  updated_at        DateTime?     @db.Timestamptz(6)
  name_id_format    String?
  sso_providers     sso_providers @relation(fields: [sso_provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([sso_provider_id])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model saml_relay_states {
  id              String        @id @db.Uuid
  sso_provider_id String        @db.Uuid
  request_id      String
  for_email       String?
  redirect_to     String?
  created_at      DateTime?     @db.Timestamptz(6)
  updated_at      DateTime?     @db.Timestamptz(6)
  flow_state_id   String?       @db.Uuid
  flow_state      flow_state?   @relation(fields: [flow_state_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sso_providers   sso_providers @relation(fields: [sso_provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)])
  @@index([for_email])
  @@index([sso_provider_id])
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model schema_migrations {
  version String @id @db.VarChar(255)

  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sessions {
  id                     String           @id @db.Uuid
  user_id                String           @db.Uuid
  created_at             DateTime?        @db.Timestamptz(6)
  updated_at             DateTime?        @db.Timestamptz(6)
  factor_id              String?          @db.Uuid
  aal                    aal_level?
  not_after              DateTime?        @db.Timestamptz(6)
  refreshed_at           DateTime?        @db.Timestamp(6)
  user_agent             String?
  ip                     String?          @db.Inet
  tag                    String?
  oauth_client_id        String?          @db.Uuid
  refresh_token_hmac_key String?
  refresh_token_counter  BigInt?
  mfa_amr_claims         mfa_amr_claims[]
  refresh_tokens         refresh_tokens[]
  oauth_clients          oauth_clients?   @relation(fields: [oauth_client_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                  users            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([not_after(sort: Desc)])
  @@index([oauth_client_id])
  @@index([user_id])
  @@index([user_id, created_at], map: "user_id_created_at_idx")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model sso_domains {
  id              String        @id @db.Uuid
  sso_provider_id String        @db.Uuid
  domain          String
  created_at      DateTime?     @db.Timestamptz(6)
  updated_at      DateTime?     @db.Timestamptz(6)
  sso_providers   sso_providers @relation(fields: [sso_provider_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([sso_provider_id])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model sso_providers {
  id                String              @id @db.Uuid
  resource_id       String?
  created_at        DateTime?           @db.Timestamptz(6)
  updated_at        DateTime?           @db.Timestamptz(6)
  disabled          Boolean?
  saml_providers    saml_providers[]
  saml_relay_states saml_relay_states[]
  sso_domains       sso_domains[]

  @@index([resource_id], map: "sso_providers_resource_id_pattern_idx")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model users {
  instance_id                              String?                @db.Uuid
  id                                       String                 @id @db.Uuid
  aud                                      String?                @db.VarChar(255)
  role                                     String?                @db.VarChar(255)
  email                                    String?                @db.VarChar(255)
  encrypted_password                       String?                @db.VarChar(255)
  email_confirmed_at                       DateTime?              @db.Timestamptz(6)
  invited_at                               DateTime?              @db.Timestamptz(6)
  confirmation_token                       String?                @db.VarChar(255)
  confirmation_sent_at                     DateTime?              @db.Timestamptz(6)
  recovery_token                           String?                @db.VarChar(255)
  recovery_sent_at                         DateTime?              @db.Timestamptz(6)
  email_change_token_new                   String?                @db.VarChar(255)
  email_change                             String?                @db.VarChar(255)
  email_change_sent_at                     DateTime?              @db.Timestamptz(6)
  last_sign_in_at                          DateTime?              @db.Timestamptz(6)
  raw_app_meta_data                        Json?
  raw_user_meta_data                       Json?
  is_super_admin                           Boolean?
  created_at                               DateTime?              @db.Timestamptz(6)
  updated_at                               DateTime?              @db.Timestamptz(6)
  phone                                    String?                @unique
  phone_confirmed_at                       DateTime?              @db.Timestamptz(6)
  phone_change                             String?                @default("")
  phone_change_token                       String?                @default("") @db.VarChar(255)
  phone_change_sent_at                     DateTime?              @db.Timestamptz(6)
  confirmed_at                             DateTime?              @default(dbgenerated("LEAST(email_confirmed_at, phone_confirmed_at)")) @db.Timestamptz(6)
  email_change_token_current               String?                @default("") @db.VarChar(255)
  email_change_confirm_status              Int?                   @default(0) @db.SmallInt
  banned_until                             DateTime?              @db.Timestamptz(6)
  reauthentication_token                   String?                @default("") @db.VarChar(255)
  reauthentication_sent_at                 DateTime?              @db.Timestamptz(6)
  is_sso_user                              Boolean                @default(false)
  deleted_at                               DateTime?              @db.Timestamptz(6)
  is_anonymous                             Boolean                @default(false)
  identities                               identities[]
  mfa_factors                              mfa_factors[]
  oauth_authorizations                     oauth_authorizations[]
  oauth_consents                           oauth_consents[]
  one_time_tokens                          one_time_tokens[]
  sessions                                 sessions[]
  audit_logs                               audit_logs[]
  system_settings                          system_settings[]
  user_profiles                            user_profiles?
  user_roles_user_roles_assigned_byTousers user_roles[]           @relation("user_roles_assigned_byTousers")
  user_roles_user_roles_user_idTousers     user_roles?            @relation("user_roles_user_idTousers")
  agents_created_by                        agents[]               @relation("agents_created_by")
  projects_user                            projects[]             @relation("projects_user")
  conversations_user                       conversations[]        @relation("conversations_user")
  corpora_created_by                       corpora[]              @relation("corpora_created_by")
  corpora_owner                            corpora[]              @relation("corpora_owner")
  agent_corpus_assignments                 agent_corpus_assignments[] @relation("assignments_assigned_by")
  corpus_documents_uploaded_by             corpus_documents[]     @relation("corpus_docs_uploaded_by")

  @@index([instance_id])
  @@index([is_anonymous])
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_logs {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String                @db.Uuid
  action          String                @db.VarChar(100)
  action_category audit_action_category
  resource_type   String?               @db.VarChar(50)
  resource_id     String?               @db.VarChar(255)
  changes         Json?
  metadata        Json?
  ip_address      String?               @db.Inet
  user_agent      String?
  created_at      DateTime              @default(now()) @db.Timestamptz(6)
  users           users                 @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_audit_logs_user_id")

  @@index([action], map: "idx_audit_logs_action")
  @@index([action_category], map: "idx_audit_logs_category")
  @@index([changes], map: "idx_audit_logs_changes", type: Gin)
  @@index([created_at(sort: Desc)], map: "idx_audit_logs_created_at")
  @@index([metadata], map: "idx_audit_logs_metadata", type: Gin)
  @@index([resource_type, resource_id], map: "idx_audit_logs_resource")
  @@index([user_id, action, created_at(sort: Desc)], map: "idx_audit_logs_user_action_date")
  @@index([user_id], map: "idx_audit_logs_user_id")
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model system_settings {
  key               String       @id @db.VarChar(100)
  value             String
  data_type         setting_type @default(string)
  category          String       @default("general") @db.VarChar(50)
  description       String?
  validation_rules  Json?
  is_public         Boolean      @default(false)
  is_encrypted      Boolean      @default(false)
  updated_by        String?      @db.Uuid
  updated_at        DateTime     @default(now()) @db.Timestamptz(6)
  created_at        DateTime     @default(now()) @db.Timestamptz(6)
  users             users?       @relation(fields: [updated_by], references: [id], onUpdate: NoAction, map: "fk_system_settings_updated_by")

  @@index([category], map: "idx_system_settings_category")
  @@index([updated_at(sort: Desc)], map: "idx_system_settings_updated_at")
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_profiles {
  user_id           String      @id @db.Uuid
  full_name         String?     @db.VarChar(255)
  avatar_url        String?
  bio               String?
  status            user_status @default(pending)
  last_login_at     DateTime?   @db.Timestamptz(6)
  last_login_ip     String?     @db.Inet
  email_verified_at DateTime?   @db.Timestamptz(6)
  phone             String?     @db.VarChar(20)
  timezone          String?     @default("UTC") @db.VarChar(50)
  language          String?     @default("es") @db.VarChar(10)
  metadata          Json?       @default("{}")
  created_at        DateTime    @default(now()) @db.Timestamptz(6)
  updated_at        DateTime    @default(now()) @db.Timestamptz(6)
  users             users       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_profiles_user_id")

  @@index([created_at(sort: Desc)], map: "idx_user_profiles_created_at")
  @@index([full_name(ops: raw("gin_trgm_ops"))], map: "idx_user_profiles_full_name_trgm", type: Gin)
  @@index([last_login_at(sort: Desc)], map: "idx_user_profiles_last_login")
  @@index([metadata], map: "idx_user_profiles_metadata", type: Gin)
  @@index([status], map: "idx_user_profiles_status")
  @@schema("public")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_roles {
  user_id                             String    @id @db.Uuid
  role                                user_role @default(user)
  assigned_by                         String?   @db.Uuid
  assigned_at                         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                          DateTime  @default(now()) @db.Timestamptz(6)
  users_user_roles_assigned_byTousers users?    @relation("user_roles_assigned_byTousers", fields: [assigned_by], references: [id], onUpdate: NoAction, map: "fk_user_roles_assigned_by")
  users_user_roles_user_idTousers     users     @relation("user_roles_user_idTousers", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_roles_user_id")

  @@index([assigned_by], map: "idx_user_roles_assigned_by")
  @@index([role], map: "idx_user_roles_role")
  @@index([updated_at(sort: Desc)], map: "idx_user_roles_updated_at")
  @@schema("public")
}

// ============================================
// CJHIRASHI APP v0.1 - NUEVAS TABLAS
// ============================================

/// Agentes inteligentes configurables por admin
/// RLS: Admin full access, users read active agents
model agents {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Metadata
  name           String  @db.VarChar(100)
  description    String?
  specialization String? @db.VarChar(100)

  // Configuración de modelos (DEPRECADA - usar agent_models)
  default_model_provider String? @db.VarChar(50)
  default_model_name     String? @db.VarChar(100)

  // Capacidades
  has_project_capability Boolean @default(false)
  project_type           String? @db.VarChar(50)
  allows_global_corpus   Boolean @default(false)
  allows_personal_corpus Boolean @default(false)

  // Configuración adicional
  capabilities Json? @default("{}")

  // Ownership
  created_by String? @db.Uuid
  created_by_user users? @relation("agents_created_by", fields: [created_by], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_agents_created_by")

  // Estado
  is_active Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  agent_models              agent_models[]
  projects                  projects[]
  conversations             conversations[]
  agent_corpus_assignments  agent_corpus_assignments[]

  // Índices
  @@index([is_active], map: "idx_agents_active")
  @@index([created_by], map: "idx_agents_created_by")
  @@index([project_type], map: "idx_agents_project_type")

  @@schema("public")
}

/// Modelos de LLM por agente (3 tiers: economy, balanced, premium)
/// RLS: Admin full access, users read models of active agents
model agent_models {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Relación con agente
  agent_id String  @db.Uuid
  agent    agents  @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_agent_models_agent_id")

  // Tier
  tier agent_model_tier

  // Configuración del modelo
  model_provider String @db.VarChar(50)
  model_name     String @db.VarChar(100)

  // Configuración de generación
  system_prompt String
  temperature   Decimal? @default(0.7) @db.Decimal(2, 1)
  max_tokens    Int?

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Constraint: Solo un modelo por tier por agente
  @@unique([agent_id, tier], map: "unique_agent_tier")

  // Índices
  @@index([agent_id], map: "idx_agent_models_agent")
  @@index([tier], map: "idx_agent_models_tier")

  @@schema("public")
}

/// Proyectos personales por usuario
/// RLS: Users manage own projects, admin read all
model projects {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Ownership (PERSONAL por usuario)
  user_id String @db.Uuid
  user    users  @relation("projects_user", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_projects_user_id")

  // Relación con agente
  agent_id String @db.Uuid
  agent    agents @relation(fields: [agent_id], references: [id], onDelete: Restrict, onUpdate: NoAction, map: "fk_projects_agent_id")

  // Metadata
  name        String  @db.VarChar(200)
  description String?

  // Tipo heredado de agente
  project_type String? @db.VarChar(50)

  // Estructura (JSON flexible)
  structure Json? @default("{}")
  metadata  Json? @default("{}")

  // Estado
  status project_status @default(active)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  conversations conversations[]
  corpora       corpora[]

  // Índices
  @@index([user_id], map: "idx_projects_user")
  @@index([agent_id], map: "idx_projects_agent")
  @@index([status], map: "idx_projects_status")
  @@index([user_id, status], map: "idx_projects_user_status")

  @@schema("public")
}

/// Historial de conversaciones con agentes
/// RLS: Users manage own conversations, admin read all
model conversations {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Ownership
  user_id String @db.Uuid
  user    users  @relation("conversations_user", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_conversations_user_id")

  // Relación con agente
  agent_id String @db.Uuid
  agent    agents @relation(fields: [agent_id], references: [id], onDelete: Restrict, onUpdate: NoAction, map: "fk_conversations_agent_id")

  // Relación opcional con proyecto
  project_id String?   @db.Uuid
  project    projects? @relation(fields: [project_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_conversations_project_id")

  // Metadata
  title String? @db.VarChar(200)

  // Mensajes (JSONB array)
  messages Json[] @default([])

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Índices
  @@index([user_id], map: "idx_conversations_user")
  @@index([agent_id], map: "idx_conversations_agent")
  @@index([project_id], map: "idx_conversations_project")
  @@index([updated_at(sort: Desc)], map: "idx_conversations_updated")

  @@schema("public")
}

/// Corpus de conocimiento (Global + Personal)
/// RLS: Complex policies for global vs personal corpus
model corpora {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Metadata
  name        String  @db.VarChar(200)
  description String?

  // Tipo de corpus (2 niveles)
  corpus_type corpus_type

  // Ownership
  created_by     String  @db.Uuid
  created_by_user users  @relation("corpora_created_by", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_corpora_created_by")

  owner_user_id  String? @db.Uuid
  owner_user     users?  @relation("corpora_owner", fields: [owner_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_corpora_owner_user_id")

  // Relación opcional con proyecto
  project_id String?   @db.Uuid
  project    projects? @relation(fields: [project_id], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_corpora_project_id")

  // Tags (búsqueda y categorización)
  tags String[] @default([])

  // Estado
  is_active Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  agent_corpus_assignments agent_corpus_assignments[]
  corpus_documents         corpus_documents[]
  embeddings               embeddings[]

  // Índices
  @@index([corpus_type], map: "idx_corpora_type")
  @@index([owner_user_id], map: "idx_corpora_owner")
  @@index([project_id], map: "idx_corpora_project")
  @@index([is_active], map: "idx_corpora_active")

  @@schema("public")
}

/// Asignación de corpus a agentes
/// RLS: Admin full access, users read accessible assignments
model agent_corpus_assignments {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Relaciones
  corpus_id String  @db.Uuid
  corpus    corpora @relation(fields: [corpus_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_assignments_corpus_id")

  agent_id String @db.Uuid
  agent    agents @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_assignments_agent_id")

  // Quién asignó
  assigned_by      String @db.Uuid
  assigned_by_user users  @relation("assignments_assigned_by", fields: [assigned_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_assignments_assigned_by")

  // Tipo de asignación
  assignment_type assignment_type

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Constraint: Solo una asignación de corpus por agente
  @@unique([agent_id, corpus_id], map: "unique_agent_corpus")

  // Índices
  @@index([corpus_id], map: "idx_assignments_corpus")
  @@index([agent_id], map: "idx_assignments_agent")
  @@index([assignment_type], map: "idx_assignments_type")

  @@schema("public")
}

/// Documentos dentro de un corpus
/// RLS: Users manage documents of own corpora, admin full access
model corpus_documents {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Relación con corpus
  corpus_id String  @db.Uuid
  corpus    corpora @relation(fields: [corpus_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_corpus_docs_corpus_id")

  // Metadata del archivo
  filename  String  @db.VarChar(255)
  file_url  String
  file_size Int?
  mime_type String? @db.VarChar(100)

  // Estado de procesamiento
  status        document_status @default(pending)
  error_message String?

  // Estadísticas
  total_chunks     Int?
  total_embeddings Int?

  // Ownership
  uploaded_by      String @db.Uuid
  uploaded_by_user users  @relation("corpus_docs_uploaded_by", fields: [uploaded_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_corpus_docs_uploaded_by")

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  embeddings embeddings[]

  // Índices
  @@index([corpus_id], map: "idx_corpus_docs_corpus")
  @@index([status], map: "idx_corpus_docs_status")
  @@index([uploaded_by], map: "idx_corpus_docs_uploaded_by")

  @@schema("public")
}

/// Embeddings de chunks (referencia a Qdrant)
/// RLS: Users read embeddings of accessible corpora, admin full access
model embeddings {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Relaciones
  corpus_id String  @db.Uuid
  corpus    corpora @relation(fields: [corpus_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_embeddings_corpus_id")

  document_id       String           @db.Uuid
  document          corpus_documents @relation(fields: [document_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_embeddings_document_id")

  // Chunk data
  chunk_text  String
  chunk_index Int

  // Referencia a Qdrant
  qdrant_point_id  String @unique @db.Uuid
  qdrant_collection String @default("cjhirashi-embeddings-production") @db.VarChar(100)

  // Metadata adicional
  metadata Json? @default("{}")

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Índices
  @@index([corpus_id], map: "idx_embeddings_corpus")
  @@index([document_id], map: "idx_embeddings_document")
  @@index([qdrant_point_id], map: "idx_embeddings_qdrant")
  @@index([qdrant_collection], map: "idx_embeddings_collection")

  @@schema("public")
}

// ============================================
// ENUMS (AUTH SCHEMA)
// ============================================

enum aal_level {
  aal1
  aal2
  aal3

  @@schema("auth")
}

enum code_challenge_method {
  s256
  plain

  @@schema("auth")
}

enum factor_status {
  unverified
  verified

  @@schema("auth")
}

enum factor_type {
  totp
  webauthn
  phone

  @@schema("auth")
}

enum oauth_authorization_status {
  pending
  approved
  denied
  expired

  @@schema("auth")
}

enum oauth_client_type {
  public
  confidential

  @@schema("auth")
}

enum oauth_registration_type {
  dynamic
  manual

  @@schema("auth")
}

enum oauth_response_type {
  code

  @@schema("auth")
}

enum one_time_token_type {
  confirmation_token
  reauthentication_token
  recovery_token
  email_change_token_new
  email_change_token_current
  phone_change_token

  @@schema("auth")
}

// ============================================
// ENUMS (PUBLIC SCHEMA - ADMIN PANEL)
// ============================================

enum audit_action_category {
  auth
  user
  role
  setting
  system

  @@schema("public")
}

enum setting_type {
  string
  number
  boolean
  json

  @@schema("public")
}

enum user_role {
  admin
  moderator
  user

  @@schema("public")
}

enum user_status {
  active
  inactive
  suspended
  pending

  @@schema("public")
}

// ============================================
// ENUMS (PUBLIC SCHEMA - CJHIRASHI v0.1)
// ============================================

enum agent_model_tier {
  economy
  balanced
  premium

  @@schema("public")
}

enum project_status {
  active
  archived
  completed

  @@schema("public")
}

enum corpus_type {
  global
  personal

  @@schema("public")
}

enum assignment_type {
  global
  personal

  @@schema("public")
}

enum document_status {
  pending
  processing
  indexed
  failed

  @@schema("public")
}
